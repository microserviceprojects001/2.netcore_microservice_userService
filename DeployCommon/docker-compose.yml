version: '3.8'

services:
  # 专用主节点 - 负责集群管理，不存储数据分片
  es-master:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-master
    environment:
      - node.name=es-master
      - cluster.name=my-es-cluster
      - discovery.seed_hosts=es-master,es-data1,es-data2
      - cluster.initial_master_nodes=es-master
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"
      - node.roles=master
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m
    ports:
      - "9200:9200"
      - "9300:9300"
    networks:
      - microservices-network

  # 数据节点1 - 负责存储数据和执行查询，可持有主分片和副本分片
  es-data1:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-data1
    environment:
      - node.name=es-data1
      - cluster.name=my-es-cluster
      - discovery.seed_hosts=es-master,es-data1,es-data2
      - cluster.initial_master_nodes=es-master
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"
      - node.roles=data
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m
    volumes:
      - es-data1:/usr/share/elasticsearch/data
    ports:
      - "9201:9200"
      - "9301:9300"
    networks:
      - microservices-network

  # 数据节点2 - 另一个数据节点，用于构成副本和高可用
  es-data2:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-data2
    environment:
      - node.name=es-data2
      - cluster.name=my-es-cluster
      - discovery.seed_hosts=es-master,es-data1,es-data2
      - cluster.initial_master_nodes=es-master
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"
      - node.roles=data
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m
    volumes:
      - es-data2:/usr/share/elasticsearch/data
    ports:
      - "9202:9200"
      - "9302:9300"
    networks:
      - microservices-network

  # Kibana - 数据可视化平台
  kibana:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/kibana:8.11.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://es-master:9200
      - XPACK_SECURITY_ENABLED=false
    ports:
      - "5601:5601"
    networks:
      - microservices-network
    depends_on:
      - es-master
      - es-data1
      - es-data2
    mem_limit: 800m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://es-master:9200"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s

  fluentd:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/fluentd-kubernetes-daemonset:v1.16.3-debian-elasticsearch8-1.0
    container_name: fluentd
    volumes:
      - ./fluentd/conf:/fluentd/etc
      - ./logs:/var/log
    ports:
      - "24224:24224"
      - "24224:24224/udp"
      - "9880:9880"
    networks:
      - microservices-network
    depends_on:
      - es-master
    mem_limit: 500m

  consul:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/consul:latest
    container_name: consul
    ports:
      - "8700:8500"
    command: >
      agent -server -bootstrap-expect=1 
      -ui -bind=0.0.0.0 -client=0.0.0.0
    volumes:
      - consul-data:/consul/data
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3

  mysql-deploy:
    image: mysql:latest
    container_name: mysql-deploy
    environment:
      - MYSQL_ROOT_PASSWORD=acsdev312
      - MYSQL_DATABASE=UserDB
      - MYSQL_INNODB_BUFFER_POOL_SIZE=256M
      - MYSQL_PERFORMANCE_SCHEMA=OFF
    ports:
      - "3308:3306"
    volumes:
      - mysql-deploy-data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
      - ./config/mysql/my.cnf:/etc/my.cnf:ro
    networks:
      - microservices-network
    restart: unless-stopped
    mem_limit: 1g
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -uroot -pacsdev312 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

volumes:
  es-data1:
    driver: local
    driver_opts:
      type: none
      device: ./data/es1
      o: bind
  es-data2:
    driver: local
    driver_opts:
      type: none
      device: ./data/es2
      o: bind
  consul-data:
    driver: local
  mysql-deploy-data:
    driver: local
    driver_opts:
      type: none
      device: ./data/mysql-deploy
      o: bind

networks:
  microservices-network:
    driver: bridge
    name: microservices-network  # 明确指定网络名称