version: '3.8'

services:
  # 专用主节点 - 负责集群管理，不存储数据分片
  es-master:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-master
    environment:
      - node.name=es-master
      - cluster.name=my-es-cluster  # 集群名称，三个节点必须相同
      - discovery.seed_hosts=es-master,es-data1,es-data2  # 节点发现列表
      - cluster.initial_master_nodes=es-master # 初始候选主节点
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"  # JVM堆内存，根据您机器内存调整
      - node.roles=master  # 此容器仅作为主节点角色
      - xpack.security.enabled=false  # 开发环境禁用安全认证（生产环境必须开启！）
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m  # Docker容器总内存限制
    ports:
      - "9200:9200"  # 宿主机端口9200映射到此容器的9200 (REST API)
      - "9300:9300"  # 宿主机端口9300映射到此容器的9300 (集群内部通信)
    networks:
      - elastic

  # 数据节点1 - 负责存储数据和执行查询，可持有主分片和副本分片
  es-data1:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-data1
    environment:
      - node.name=es-data1
      - cluster.name=my-es-cluster
      - discovery.seed_hosts=es-master,es-data1,es-data2
      - cluster.initial_master_nodes=es-master
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"
      - node.roles=data  # 此容器仅作为数据节点角色
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m
    volumes:
      - es-data1:/usr/share/elasticsearch/data  # 使用命名卷持久化数据，避免Windows路径问题
    ports:
      - "9201:9200"  # 宿主机端口9201映射到此容器的9200
      - "9301:9300"  # 宿主机端口9301映射到此容器的9300
    networks:
      - elastic

  # 数据节点2 - 另一个数据节点，用于构成副本和高可用
  es-data2:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/elasticsearch:8.11.0
    container_name: es-data2
    environment:
      - node.name=es-data2
      - cluster.name=my-es-cluster
      - discovery.seed_hosts=es-master,es-data1,es-data2
      - cluster.initial_master_nodes=es-master
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms400m -Xmx400m"
      - node.roles=data
      - xpack.security.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    mem_limit: 800m
    volumes:
      - es-data2:/usr/share/elasticsearch/data
    ports:
      - "9202:9200"  # 宿主机端口9202映射到此容器的9200
      - "9302:9300"  # 宿主机端口9302映射到此容器的9300
    networks:
      - elastic
  # Kibana - 数据可视化平台
  kibana:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/kibana:8.11.0
    container_name: kibana
    environment:
      - ELASTICSEARCH_HOSTS=http://es-master:9200 # 核心：通过容器名连接
      # 如果未来开启安全认证，需添加如下配置（当前未开启）：
      # - ELASTICSEARCH_USERNAME=kibana_system
      # - ELASTICSEARCH_PASSWORD=your_password
      - XPACK_SECURITY_ENABLED=false # 与ES配置保持一致
    ports:
      - "5601:5601"
    networks:
      - elastic
    depends_on:
      - es-master
      - es-data1
      - es-data2
    mem_limit: 800m
    # 可选：增加健康检查，确保Kibana在ES完全就绪后才启动
    healthcheck:
      test: ["CMD", "curl", "-f", "http://es-master:9200"]
      interval: 10s
      timeout: 5s
      retries: 20
      start_period: 30s
  fluentd:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/fluentd-kubernetes-daemonset:v1.16.3-debian-elasticsearch8-1.0
    container_name: fluentd
    volumes:
      # Windows路径：挂载当前目录下的 fluentd/conf 文件夹作为配置目录
      - ./fluentd/conf:/fluentd/etc
      # 挂载日志目录，用于收集Web应用产生的日志文件
      - ./logs:/var/log
    ports:
      - "24224:24224"
      - "24224:24224/udp"
      - "9880:9880"
    networks:
      - elastic
    depends_on:
      - es-master
    mem_limit: 500m
 
  consul:
    image: registry.cn-hangzhou.aliyuncs.com/abelcontainer/consul:latest
    container_name: consul
    ports:
      - "8500:8500"  # Web UI
    command: >
      agent -server -bootstrap-expect=1 
      -ui -bind=0.0.0.0 -client=0.0.0.0
    volumes:
      - consul-data:/consul/data
    networks:
      - elastic
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/v1/status/leader"]
      interval: 30s
      timeout: 10s
      retries: 3
  # 定义数据卷，数据将持久化保存在这里
  mysql-deploy:
    image: mysql:latest  # 改为稳定的 8.0 版本
    container_name: mysql-deploy
    environment:
      - MYSQL_ROOT_PASSWORD=acsdev312
      - MYSQL_DATABASE=UserDB
      # 内存优化
      - MYSQL_INNODB_BUFFER_POOL_SIZE=256M
      - MYSQL_PERFORMANCE_SCHEMA=OFF
    ports:
      - "3308:3306"
    volumes:
      - mysql-deploy-data:/var/lib/mysql
      # 挂载初始化脚本目录,语法：宿主机路径:容器内路径:选项
      - ./mysql-init:/docker-entrypoint-initdb.d:ro
      - ./config/mysql/my.cnf:/etc/my.cnf:ro 
    networks:
      - elastic
    restart: unless-stopped
    # command: >
    #   bash -c "
    #   # 复制配置文件并设置正确权限
    #   cp /tmp/my.cnf /etc/mysql/conf.d/my.cnf &&
    #   chmod 644 /etc/mysql/conf.d/my.cnf &&
    #   # 启动 MySQL
    #   docker-entrypoint.sh mysqld
    #   "
    mem_limit: 1g
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -uroot -pacsdev312 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s
volumes:
  es-data1:
    driver: local
    driver_opts:
      type: none
      device: ./data/es1  # 映射到本地目录
      o: bind
  es-data2:
    driver: local
    driver_opts:
      type: none
      device: ./data/es2
      o: bind
  consul-data:
    driver: local
  mysql-deploy-data:
    driver: local
    driver_opts:
      type: none
      device: ./data/mysql-deploy  # 数据持久化目录
      o: bind
# 定义容器使用的网络，便于彼此发现和通信
networks:
  elastic:
    driver: bridge
