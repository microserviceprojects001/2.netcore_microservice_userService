version: '3.8'

services:
  user-identity:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.identity:v1
    container_name: user-identity
    ports:
      - "5103:80"
      - "7024:445"  # ✅ 根据你的配置，这是正确的
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # 服务发现与健康检查配置
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=user-identity
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
    networks:
      - elastic  # ✅ 使用 DeployCommon 定义的网络
    restart: unless-stopped
    # 移除 depends_on，因为 consul 在另一个 compose 文件中
    # depends_on:
    #   consul:
    #     condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/HealthCheck"]
      interval: 30s
      timeout: 10s
      retries: 3
  user-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.api:v1
    container_name: user-api
    ports:
      - "5104:80"
      - "7026:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Consul服务发现配置
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=user-api
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck

    networks:
      - elastic
    # depends_on:
    #   mysql-deploy:
    #     condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
# 不需要 volumes 部分，因为 consul-data 在 DeployCommon 中定义
  recommend-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/recommend.api:v1
    container_name: recommend-api
    ports:
      - "5105:80"
      - "7027:446"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Consul服务发现配置
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false

    networks:
      - elastic
  project-api:
      image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/project.api:v1
      container_name: project-api
      ports:
        - "5106:80"
        - "7028:447"
      environment:
        - ASPNETCORE_ENVIRONMENT=Production
        # Consul服务发现配置
        - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
        - ServerDiscovery__UseHttps=false
        - ServerDiscovery__HealthCheck__Host=project-api
        - ServerDiscovery__HealthCheck__Port=80
        - ServerDiscovery__HealthCheck__Path=/HealthCheck

      networks:
        - elastic
      # depends_on:
      #   mysql-deploy:
      #     condition: service_healthy
      restart: unless-stopped
      healthcheck:
        test: ["CMD", "curl", "-f", "http://localhost/health"]
        interval: 30s
        timeout: 10s
        retries: 3
  contact-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/contact.api:v1
    container_name: contact-api
    ports:
      - "5107:80"
      - "7029:448"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      # Consul服务发现配置
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=contact-api
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck

    networks:
      - elastic
    # depends_on:
    #   mysql-deploy:
    #     condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
networks:
  elastic:
    external: true  # ✅ 使用外部网络
    name: deploycommon_elastic  # 网络名称（自动生成或指定）