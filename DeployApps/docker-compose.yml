version: '3.8'

services:
  user-identity:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.identity:v1
    container_name: user-identity
    ports:
      - "5103:80"
      - "7024:445"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=user-identity
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.user-identity"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/HealthCheck"]
      interval: 30s
      timeout: 10s
      retries: 3

  user-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/user.api:v1
    container_name: user-api
    ports:
      - "5104:80"
      - "7026:443"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=user-api
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.user-api"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  recommend-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/recommend.api:v1
    container_name: recommend-api
    ports:
      - "5105:80"
      - "7027:446"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.recommend-api"
    networks:
      - microservices-network

  project-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/project.api:v1
    container_name: project-api
    ports:
      - "5106:80"
      - "7028:447"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=project-api
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.project-api"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  contact-api:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/contact.api:v1
    container_name: contact-api
    ports:
      - "5107:80"
      - "7029:448"
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ServerDiscovery__Consul__HttpEndpoint=http://consul:8500
      - ServerDiscovery__UseHttps=false
      - ServerDiscovery__HealthCheck__Host=contact-api
      - ServerDiscovery__HealthCheck__Port=80
      - ServerDiscovery__HealthCheck__Path=/HealthCheck
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.contact-api"
    networks:
      - microservices-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  api-gateway:
    image: registry.cn-hangzhou.aliyuncs.com/microsoftservice/api.gateway:v1
    container_name: api-gateway
    ports:
      - "5108:80"
      - "7030:447"
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "prod.api-gateway"
    networks:
      - microservices-network
    restart: unless-stopped

networks:
  microservices-network:
    external: true
    name: microservices-network  # 引用外部网络